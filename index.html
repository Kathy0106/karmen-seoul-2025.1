<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>2025 Christmas SEOUL trip ğŸ„</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    *{
      box-sizing:border-box;
      margin:0;
      padding:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
    }
    body{
      background:#f4f7fb;
      color:#222;
      padding-top:env(safe-area-inset-top);
    }
    .app{
      max-width:480px;
      margin:0 auto 40px;
      background:#f4f7fb;
    }

    /* â”€â”€â”€ Hero â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .hero{
      position:relative;
      height:170px;
      overflow:hidden;
      border-bottom-left-radius:24px;
      border-bottom-right-radius:24px;
      background:#0b6b4a url('cover.jpg') center/cover no-repeat;
      color:#fff;
    }
    .hero::after{
      content:"";
      position:absolute;
      inset:0;
      background:linear-gradient(180deg,rgba(0,0,0,0.55),rgba(0,0,0,0.18));
    }
    .hero-inner{
      position:relative;
      z-index:1;
      padding:12px 16px 8px;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      height:100%;
    }
    .hero-row-top{
      display:flex;
      justify-content:space-between;
      gap:8px;
      align-items:flex-start;
    }
    .hero-title{
      font-size:20px;
      font-weight:700;
      line-height:1.2;
    }
    .hero-dates{
      margin-top:4px;
      font-size:13px;
      opacity:.9;
    }
    .hero-dest{
      margin-left:auto;
      text-align:right;
      font-size:11px;
    }
    .hero-dest strong{
      display:block;
      font-size:18px;
    }
    .badge-small{
      display:inline-flex;
      align-items:center;
      gap:4px;
      font-size:10px;
      padding:3px 7px;
      border-radius:999px;
      background:rgba(0,0,0,0.25);
    }
    .edit-toggle{
      font-size:11px;
      padding:4px 9px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.7);
      background:rgba(0,0,0,0.15);
      color:#fff;
      cursor:pointer;
      white-space:nowrap;
    }
    .edit-toggle.active{
      background:#ffe0eb;
      color:#c02b5b;
      border-color:#ffe0eb;
    }
    .hero-tabs{
      margin-top:10px;
      display:flex;
      gap:10px;
    }
    .hero-tab{
      flex:1;
      text-align:center;
      padding:6px 0;
      font-size:12px;
      border-radius:999px;
      border:none;
      background:rgba(255,255,255,0.18);
      color:#e1f6ec;
      cursor:pointer;
    }
    .hero-tab.active{
      background:#ffffff;
      color:#0b6b4a;
      font-weight:600;
    }

    /* â”€â”€â”€ Day pills â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .day-strip{
      margin-top:0;
      padding:0 12px;
    }
    .day-scroll{
      display:flex;
      overflow-x:auto;
      gap:8px;
      padding:6px 0 6px;
    }
    .day-pill{
      min-width:76px;
      padding:6px 8px;
      border-radius:12px;
      background:#e3f3ea;
      text-align:center;
      font-size:11px;
      color:#35524a;
      cursor:pointer;
      flex-shrink:0;
    }
    .day-pill span{display:block;}
    .day-pill .date{font-weight:600;font-size:12px;}
    .day-pill.active{
      background:#0b6b4a;
      color:#fff;
    }

    /* â”€â”€â”€ Main content â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .content{
      padding:8px 12px 24px;
    }
    .top-actions{
      display:flex;
      justify-content:flex-end;
      gap:8px;
      margin-bottom:4px;
      font-size:11px;
    }
    .top-actions button{
      padding:4px 8px;
      border-radius:999px;
      border:1px solid #c1d7cc;
      background:#ffffff;
      cursor:pointer;
      color:#0b6b4a;
    }

    /* â”€â”€â”€ Weather card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .weather-card{
      margin-top:4px;
      background:#fff;
      border-radius:16px;
      padding:12px 12px 10px;
      display:flex;
      align-items:center;
      box-shadow:0 4px 10px rgba(0,0,0,0.04);
      gap:10px;
    }
    .weather-icon{
      width:40px;height:40px;border-radius:50%;
      background:#eaf6ff;
      display:flex;align-items:center;justify-content:center;
      font-size:22px;
    }
    .weather-main{flex:1;}
    .temp-row{font-size:20px;font-weight:700;}
    .temp-low{font-size:12px;margin-left:4px;color:#777;}
    .feel{font-size:11px;color:#777;margin-top:2px;}
    .weather-note{
      font-size:11px;
      color:#555;
      text-align:right;
      min-width:100px;
    }
    .weather-note strong{display:block;font-size:12px;}
    .weather-btn{
      margin-top:4px;
      font-size:10px;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid #c6ddff;
      background:#f5f7ff;
      color:#3557ff;
      cursor:pointer;
    }

    /* â”€â”€â”€ Itinerary cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .section-title{
      margin:14px 4px 6px;
      font-size:13px;
      font-weight:600;
      color:#444;
    }

    .card{
      background:#fff;
      border-radius:18px;
      padding:10px 12px;
      margin-bottom:10px;
      display:flex;
      gap:10px;
      box-shadow:0 3px 8px rgba(0,0,0,0.04);
      position:relative;
    }
    .card-icon-wrap{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:4px;
      width:40px;
    }
    .card-icon-circle{
      width:32px;height:32px;
      border-radius:50%;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:18px;
      color:#fff;
    }
    .card-icon-label{
      font-size:10px;
      color:#666;
      text-align:center;
    }
    .card-body{
      flex:1;
      min-width:0;
    }
    .card-title-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:6px;
      margin-bottom:2px;
    }
    .card-title{
      font-size:13px;
      font-weight:600;
    }
    .card-sub{
      font-size:11px;
      color:#666;
    }
    .card-meta{
      font-size:11px;
      color:#777;
      margin-top:2px;
      display:flex;
      flex-wrap:wrap;
      gap:6px;
    }
    .meta-pill{
      background:#f3f6fb;
      border-radius:999px;
      padding:1px 7px;
      font-size:10px;
    }
    .card-note{
      font-size:11px;
      color:#555;
      margin-top:4px;
      white-space:pre-wrap;
    }
    .card-footer{
      display:flex;
      justify-content:flex-end;
      gap:4px;
      margin-top:6px;
    }
    .icon-btn{
      border:none;
      background:#f3f6fb;
      border-radius:50%;
      width:24px;
      height:24px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:13px;
      cursor:pointer;
      color:#555;
    }
    .icon-btn.primary{
      background:#0b6b4a;
      color:#fff;
    }
    .move-time{
      font-size:10px;
      color:#999;
      margin:2px 0 6px 52px;
    }

    /* â”€â”€â”€ Generic table / panels â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .table{
      width:100%;
      border-collapse:collapse;
      font-size:12px;
      background:#fff;
      border-radius:14px;
      overflow:hidden;
      box-shadow:0 3px 8px rgba(0,0,0,0.03);
    }
    .table th,
    .table td{
      padding:6px 6px;
      border-bottom:1px solid #eef1fb;
    }
    .table th{
      background:#f5f7ff;
      font-weight:600;
    }
    .table input{
      width:100%;
      border-radius:6px;
      border:1px solid #dde3f0;
      padding:3px 4px;
      font-size:11px;
    }
    .table-actions{
      margin-top:8px;
      display:flex;
      gap:8px;
      justify-content:flex-end;
    }
    .btn-pill{
      font-size:11px;
      padding:5px 10px;
      border-radius:999px;
      border:none;
      cursor:pointer;
    }
    .btn-secondary{
      background:#fff;
      border:1px solid #c1d7cc;
      color:#0b6b4a;
    }
    .btn-primary{
      background:#0b6b4a;
      color:#fff;
    }
    .del-btn{
      font-size:11px;
      padding:2px 6px;
      border-radius:999px;
      border:1px solid #f2b2bd;
      background:#fff1f3;
      color:#e06276;
      cursor:pointer;
    }
    .total-row{
      margin-top:6px;
      font-size:12px;
      text-align:right;
      color:#444;
    }

    /* â”€â”€â”€ Info / FX / hotel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .info-card{
      background:#fff;
      border-radius:18px;
      padding:10px 12px;
      margin-bottom:10px;
      box-shadow:0 3px 8px rgba(0,0,0,0.04);
    }
    .info-title{
      font-size:13px;
      font-weight:600;
      margin-bottom:6px;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .info-row{
      display:flex;
      align-items:center;
      gap:6px;
      margin-bottom:6px;
      font-size:12px;
    }
    .info-row label{
      min-width:70px;
      color:#666;
      font-size:11px;
    }
    .info-row input{
      flex:1;
      font-size:12px;
      padding:4px 6px;
      border-radius:8px;
      border:1px solid #dde3f0;
    }

    /* â”€â”€â”€ Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.45);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:20;
    }
    .modal{
      width:90%;
      max-width:420px;
      max-height:80%;
      overflow-y:auto;
      background:#f6f8fb;
      border-radius:18px;
      box-shadow:0 16px 32px rgba(0,0,0,0.25);
      padding:14px;
    }
    .modal-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:8px;
    }
    .modal-header h2{
      font-size:16px;
    }
    .modal-body{
      font-size:12px;
    }
    .form-row{
      margin-bottom:8px;
    }
    .form-row label{
      display:block;
      font-size:11px;
      color:#555;
      margin-bottom:2px;
    }
    .form-row input,
    .form-row textarea,
    .form-row select{
      width:100%;
      font-size:12px;
      padding:5px 7px;
      border-radius:8px;
      border:1px solid #dde3f0;
      resize:vertical;
    }
    .form-row textarea{
      min-height:60px;
    }
    .modal-footer{
      display:flex;
      justify-content:space-between;
      gap:8px;
      margin-top:10px;
    }
    .btn-danger{
      background:#ff5b7a;
      color:#fff;
    }
    .btn-ghost{
      background:#ffffff;
      color:#555;
      border:1px solid #dde3f0;
    }

    .small-note{
      font-size:11px;
      color:#777;
      margin-top:6px;
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="hero">
      <div class="hero-inner">
        <div class="hero-row-top">
          <div>
            <div class="badge-small">ğŸ„ Christmas Seoul</div>
            <div class="hero-title">2025 Christmas SEOUL trip</div>
            <div class="hero-dates">2025.12.25 â€“ 12.29</div>
          </div>
          <div class="hero-dest">
            <div>ç›®çš„åœ°</div>
            <strong>Seoul</strong>
          </div>
          <button id="editToggle" class="edit-toggle">âœï¸ ç·¨è¼¯è¡Œç¨‹</button>
        </div>
        <div class="hero-tabs">
          <button class="hero-tab active" id="tab-itinerary">ğŸ—º è¡Œç¨‹</button>
          <button class="hero-tab" id="tab-expense">ğŸ’° æ¶ˆè²»</button>
          <button class="hero-tab" id="tab-flight">âœˆï¸ èˆªç­</button>
          <button class="hero-tab" id="tab-info">â„¹ï¸ è³‡è¨Š</button>
        </div>
      </div>
    </header>

    <div class="day-strip" id="dayStrip"></div>

    <main class="content">
      <div class="top-actions">
        <button id="btnWeatherAll">â„ï¸ æ›´æ–°å³æ™‚å¤©æ°£</button>
        <button id="btnPrint">ğŸ–¨ åŒ¯å‡º / PDF</button>
      </div>
      <section id="panel-itinerary"></section>
      <section id="panel-expense" style="display:none;"></section>
      <section id="panel-flight" style="display:none;"></section>
      <section id="panel-info" style="display:none;"></section>
    </main>
  </div>

  <!-- è¡Œç¨‹ç·¨è¼¯ Modal -->
  <div id="modalBackdrop" class="modal-backdrop">
    <div class="modal">
      <div class="modal-header">
        <h2>ç·¨è¼¯è¡Œç¨‹</h2>
        <button id="btnModalClose" class="icon-btn">âœ•</button>
      </div>
      <div class="modal-body">
        <div class="form-row">
          <label>é¡åˆ¥</label>
          <select id="fType">
            <option value="transport">äº¤é€š</option>
            <option value="flight">èˆªç­</option>
            <option value="food">é¤å»³ / é£²é£Ÿ</option>
            <option value="sight">æ™¯é» / æ´»å‹•</option>
            <option value="hotel">ä½å®¿</option>
            <option value="shopping">è³¼ç‰©</option>
            <option value="other">å…¶ä»–</option>
          </select>
        </div>
        <div class="form-row">
          <label>é¡¯ç¤º iconï¼ˆemojiï¼‰</label>
          <input id="fIcon" placeholder="ä¾‹å¦‚ ğŸš‡ / ğŸ½ / ğŸ¨ / âœˆï¸">
        </div>
        <div class="form-row">
          <label>æ™‚é–“ï¼ˆä¾‹ï¼š~14:30 / æ—©ä¸Šï¼‰</label>
          <input id="fTime">
        </div>
        <div class="form-row">
          <label>æ¨™é¡Œï¼ˆåº—å / è¡Œç¨‹ï¼‰</label>
          <input id="fTitle">
        </div>
        <div class="form-row">
          <label>åœ°é» / ç°¡çŸ­èªªæ˜</label>
          <input id="fLocation" placeholder="ä¾‹ï¼šå¼˜å¤§å…¥å£ç«™ 9 è™Ÿå‡ºå£">
        </div>
        <div class="form-row">
          <label>ç‡Ÿæ¥­æ™‚é–“ / ç§»å‹•æ™‚é–“</label>
          <input id="fBizTime" placeholder="ä¾‹ï¼š17:00â€“20:30 / è»Šç¨‹ 60â€“80 åˆ†é˜">
        </div>
        <div class="form-row">
          <label>é–€ç¥¨ / è²»ç”¨</label>
          <input id="fFee" placeholder="ä¾‹ï¼šç´„ â‚©14,000 / äºº">
        </div>
        <div class="form-row">
          <label>å‚™è¨»</label>
          <textarea id="fNote" placeholder="å¯«å¤šå•²ç´°ç¯€ã€æ’éšŠæ™‚é–“ã€å°è²¼å£«â€¦"></textarea>
        </div>
        <div class="form-row">
          <label>åœ°åœ–é€£çµï¼ˆNaver / Googleï¼‰</label>
          <input id="fMap" placeholder="https://naver.me/...">
        </div>
        <div class="form-row">
          <label>ä¸Šä¸€é …è‡³å‘¢é …çš„ç§»å‹•æ™‚é–“ï¼ˆåˆ†é˜ï¼Œå¯ç•™ç©ºï¼‰</label>
          <input id="fMove" placeholder="ä¾‹ï¼š10ï¼ˆä»£è¡¨ 10 minï¼‰">
        </div>
      </div>
      <div class="modal-footer">
        <button id="btnModalDelete" class="btn-pill btn-danger">åˆªé™¤</button>
        <div style="flex:1;"></div>
        <button id="btnModalCancel" class="btn-pill btn-ghost">å–æ¶ˆ</button>
        <button id="btnModalSave" class="btn-pill btn-primary">å„²å­˜ä¿®æ”¹</button>
      </div>
    </div>
  </div>

  <script>
    /* ====== åŸºæœ¬è¨­å®š ====== */
    const API_KEY = "bd5e378503939ddaee76f12ad7a97608";
    const STORAGE_KEY = "seoul_trip_christmas_v3";

    const typeColors = {
      transport:"#ffa64d",
      flight:"#4da6ff",
      food:"#ff5b7a",
      sight:"#7e5bff",
      hotel:"#5cce9d",
      shopping:"#ffb74d",
      other:"#94a3b8"
    };

    /* ====== åˆå§‹è¡Œç¨‹è³‡æ–™ï¼ˆå·²æ ¹æ“šä½ æœ€æ–° versionï¼‰ ====== */
    const baseTrip = {
      days:[
        {
          id:"d1",
          labelShort:"12/25",
          weekday:"å››",
          title:"Day 1ï½œå®‰åœ‹ â†’ å¼˜å¤§ â†’ å»¶å—æ´ â†’ æ˜æ´ç‡ˆé£¾",
          city:"Seoul",
          weather:{temp:"",low:"",feel:"",text:"",note:"å®‰åœ‹ã€å¼˜å¤§ã€å»¶å—æ´æ…¢è¡Œï¼‹æ˜æ´è–èª•ç‡ˆé£¾"},
          blocks:[
            {
              id:"d1b1",type:"food",icon:"ğŸ½",time:"æ—©ä¸Š",
              title:"Dotori Garden",
              location:"ë„í† ë¦¬ê°€ë“  Â· ì„œìš¸ ì¢…ë¡œêµ¬ ë¶ì´Œë¡œ4ê¸¸ 20",
              bizTime:"",fee:"",note:"",
              map:"",move:0
            },
            {
              id:"d1b2",type:"sight",icon:"ğŸ›",time:"ä¸Šåˆ",
              title:"å®‰åœ‹é€›è¡—é †è·¯",
              location:"ZERO SPACE / Object å®‰åœ‹ / Sowol Department / INOUR MANSION / OINU / Tamburins å®‰åœ‹",
              bizTime:"",
              fee:"",
              note:"ZERO SPACEï¼ˆì œë¡œìŠ¤í˜ì´ìŠ¤ï¼‰Â· Object ì•ˆêµ­ Â· ì†Œì›”ë””íŒŒíŠ¸ë¨¼íŠ¸ Â· ì´ë„ˆë§¨ì…˜ Â· ì˜¤ì´ëˆ„ Â· íƒ¬ë²„ë¦°ì¦ˆ ì•ˆêµ­",
              map:"",move:8
            },
            {
              id:"d1b3",type:"transport",icon:"ğŸš‡",time:"ä¸­åˆå‰",
              title:"å®‰åœ‹ â†’ å¼˜å¤§å…¥å£ï¼ˆåœ°éµï¼‰",
              location:"ç´„ 18 åˆ†é˜ï¼ˆè½‰ä¹˜ä¸€æ¬¡ï¼‰",
              bizTime:"ç§»å‹•ç´„ 18 åˆ†é˜",
              fee:"",note:"",
              map:"",move:18
            },
            {
              id:"d1b4",type:"food",icon:"ğŸ½",time:"ä¸­åˆ",
              title:"Gop Mapo çƒ¤è‚¥è…¸",
              location:"ê³±ë§ˆí¬ Â· ì„œìš¸ ë§ˆí¬êµ¬ ë…ë§‰ë¡œ7ê¸¸ 51",
              bizTime:"",fee:"",note:"",
              map:"",move:5
            },
            {
              id:"d1b5",type:"food",icon:"â˜•ï¸",time:"ä¸‹åˆ",
              title:"Artist Bakery å¼˜å¤§",
              location:"ì•„í‹°ìŠ¤íŠ¸ ë² ì´ì»¤ë¦¬ Â· ì„œìš¸ ë§ˆí¬êµ¬ ë™êµë¡œ 251-3",
              bizTime:"",fee:"",note:"",
              map:"",move:8
            },
            {
              id:"d1b6",type:"transport",icon:"ğŸš¶â€â™€ï¸",time:"ä¸‹åˆ",
              title:"æ­¥è¡Œ â†’ å»¶å—æ´",
              location:"å¾’æ­¥ç´„ 12 åˆ†é˜",
              bizTime:"æ­¥è¡Œç´„ 12 åˆ†é˜",
              fee:"",note:"",
              map:"",move:12
            },
            {
              id:"d1b7",type:"food",icon:"ğŸ®",time:"ä¸‹åˆ",
              title:"å»¶å—æ´é£Ÿ & CafÃ©",
              location:"í›ˆí›ˆí˜¸ë–¡ Â· íˆí¬ì»¤í”¼ ä¸€å¸¶",
              bizTime:"",
              fee:"",
              note:"HUNHUN ç³–é¤…ï¼ˆí›ˆí›ˆí˜¸ë–¡ï¼‰Â· ì„œìš¸ ë§ˆí¬êµ¬ ë™êµë¡œ30ê¸¸ 19\nHIPPO Coffeeï¼ˆíˆí¬ì»¤í”¼ï¼‰Â· ì„œìš¸ ë§ˆí¬êµ¬ ë™êµë¡œ 266-6",
              map:"",move:10
            },
            {
              id:"d1b8",type:"transport",icon:"ğŸš‡",time:"å‚æ™š",
              title:"å»¶å—æ´ â†’ æ˜æ´ï¼ˆåœ°éµï¼‰",
              location:"å¯åˆ°ä¹™æ”¯è·¯å…¥å£ / æ˜æ´ç«™ï¼Œç´„ 25â€“30 åˆ†é˜",
              bizTime:"ç§»å‹•æ™‚é–“ç´„ 25â€“30 åˆ†é˜",
              fee:"",note:"",
              map:"",move:25
            },
            {
              id:"d1b9",type:"food",icon:"ğŸ¦€",time:"æ™šé¤",
              title:"çƒé”é‡Œå®¶ï¼ˆé†¬èŸ¹ï¼‰",
              location:"ì˜¤ë‹¤ë¦¬ì§‘ ê°„ì¥ê²Œì¥ Â· ì„œìš¸ ì¤‘êµ¬ ëª…ë™8ë‚˜ê¸¸ 28 2â€“3ì¸µ",
              bizTime:"",fee:"",note:"",
              map:"",move:8
            },
            {
              id:"d1b10",type:"sight",icon:"ğŸ„",time:"æ™šä¸Š",
              title:"æ˜æ´è–èª•ç‡ˆé£¾ & æ˜æ´è–å ‚",
              location:"ëª…ë™ì„±ë‹¹ Â· ì„œìš¸ ì¤‘êµ¬ ëª…ë™ê¸¸ 74",
              bizTime:"",fee:"",
              note:"æ™šé¤å¾Œæ­¥è¡Œå»æ˜æ´è–å ‚ï¼Œå†è¡Œç•ªæ˜æ´å¤§è¡—ç‡ç‡ˆé£¾",
              map:"",move:5
            }
          ]
        },
        {
          id:"d2",
          labelShort:"12/26",
          weekday:"äº”",
          title:"Day 2ï½œæ˜æ´ â†’ å—å¤§é–€ â†’ æ±å¤§é–€ â†’ æ–°å ‚",
          city:"Seoul",
          weather:{temp:"",low:"",feel:"",text:"",note:"æ˜æ´ & å—å¤§é–€ & æ±å¤§é–€è³¼ç‰©ï¼‹æ–°å ‚è¾£é›çˆª"},
          blocks:[
            {
              id:"d2b1",type:"food",icon:"ğŸ½",time:"æ—©ä¸Š",
              title:"å®‹å®¶é£¯æ²ï¼ˆæ˜æ´ï¼‰",
              location:"ì†¡ê°€ê¹€ë°¥ Â· ì„œìš¸ ì¤‘êµ¬ í‡´ê³„ë¡œ 120",
              bizTime:"",fee:"",note:"",
              map:"",move:0
            },
            {
              id:"d2b2",type:"shopping",icon:"ğŸ›",time:"ä¸Šåˆ",
              title:"æ˜æ´è³¼ç‰©å€",
              location:"ëª…ë™ê±°ë¦¬ Â· ì„œìš¸ ì¤‘êµ¬ ëª…ë™ê¸¸ ì¼ëŒ€",
              bizTime:"",fee:"",note:"",
              map:"",move:5
            },
            {
              id:"d2b3",type:"food",icon:"ğŸ½",time:"ä¸­åˆ",
              title:"éŸ“ç‰›ä¸€æ¢è¡—ï¼ˆé€€æºªè·¯ï¼‰",
              location:"í‡´ê³„ë¡œ í•œìš°ê³¨ëª© Â· ì„œìš¸ ä¸­êµ¬ í‡´ê³„ë¡œ180ê¸¸ ä¸€å¸¶",
              bizTime:"",fee:"",note:"",
              map:"",move:10
            },
            {
              id:"d2b4",type:"sight",icon:"ğŸ›",time:"ä¸‹åˆ",
              title:"å—å¤§é–€å¸‚å ´",
              location:"ë‚¨ëŒ€ë¬¸ì‹œì¥ Â· ì„œìš¸ ä¸­êµ¬ ë‚¨ëŒ€ë¬¸ì‹œì¥4ê¸¸ 21",
              bizTime:"",fee:"",note:"",
              map:"",move:10
            },
            {
              id:"d2b5",type:"shopping",icon:"ğŸ›",time:"å‚æ™šå‰",
              title:"Doota Mall + No Brand",
              location:"ë‘íƒ€ëª° Â· ì„œìš¸ ä¸­êµ¬ ì¥ì¶©ë‹¨ë¡œ 275",
              bizTime:"",fee:"",note:"",
              map:"",move:10
            },
            {
              id:"d2b6",type:"food",icon:"ğŸ¨",time:"å‚æ™š",
              title:"Scooper Gelatoï¼ˆAFFOGATOï¼‰",
              location:"ìŠ¤ì¿ í¼ ì ¤ë¼í†  Â· Doota Mall åœ°ä¸‹å±¤",
              bizTime:"",fee:"",note:"",
              map:"",move:5
            },
            {
              id:"d2b7",type:"food",icon:"ğŸ”¥",time:"æ™šä¸Š",
              title:"å‹èª¼è¾£é›çˆªï¼ˆæ–°å ‚ï¼‰",
              location:"ìš°ì •ë‹­ë°œ Â· ì„œìš¸ ä¸­êµ¬ í‡´ê³„ë¡œ 421ï¼ˆæ–°å ‚ë‹­ë°œê³¨ëª©ï¼‰",
              bizTime:"",fee:"",note:"",
              map:"",move:20
            }
          ]
        },
        {
          id:"d3",
          labelShort:"12/27",
          weekday:"å…­",
          title:"Day 3ï½œå®‰åœ‹ CafÃ© â†’ ç›Šå–„æ´ â†’ ä¹™æ”¯è·¯",
          city:"Seoul",
          weather:{temp:"",low:"",feel:"",text:"",note:"å®‰åœ‹ cafÃ©ï¼‹ç›Šå–„æ´å°åº—ï¼‹ä¹™æ”¯è·¯çƒ¤è‚‰ chill day"},
          blocks:[
            {
              id:"d3b1",type:"food",icon:"ğŸ°",time:"æ—©ä¸Š",
              title:"Cafe Layeredï¼ˆå®‰åœ‹ï¼‰",
              location:"ì¹´í˜ ë ˆì´ì–´ë“œ Â· ì„œìš¸ ì¢…ë¡œêµ¬ ë¶ì´Œë¡œ 6",
              bizTime:"",fee:"",note:"",
              map:"",move:0
            },
            {
              id:"d3b2",type:"food",icon:"ğŸ½",time:"ä¸­åˆ",
              title:"Nakwonjangï¼ˆç›Šå–„æ´ï¼‰",
              location:"ë‚™ì›ì¥ Â· ì„œìš¸ ì¢…ë¡œêµ¬ ìˆ˜í‘œë¡œ28ê¸¸ 33",
              bizTime:"",fee:"",note:"",
              map:"",move:8
            },
            {
              id:"d3b3",type:"sight",icon:"ğŸ›",time:"ä¸‹åˆ",
              title:"ç›Šå–„æ´è¡Œå°åº—ï¼æ‰“å¡",
              location:"ìµì„ ë™ í•œì˜¥ê±°ë¦¬ Â· ì„œìš¸ ì¢…ë¡œêµ¬ ìˆ˜í‘œë¡œ28ê¸¸ ä¸€å¸¶",
              bizTime:"",fee:"",note:"",
              map:"",move:10
            },
            {
              id:"d3b4",type:"food",icon:"ğŸ½",time:"æ™šä¸Š",
              title:"æ°´èŠ¹èœçƒ¤è±¬è‚‰ï¼ˆä¹™æ”¯è·¯ï¼‰",
              location:"ëŒíŒ ìˆ˜ë¯¸ë‚˜ë¬¼ ì‚¼ê²¹ì‚´ Â· ì„œìš¸ ä¸­êµ¬ ìˆ˜í‘œë¡œ 48-1",
              bizTime:"",fee:"",note:"",
              map:"",move:15
            },
            {
              id:"d3b5",type:"other",icon:"ğŸŒ™",time:"å¤œæ™š",
              title:"é£¯å¾Œè‡ªç”±æ´»å‹•",
              location:"å›é…’åº— / ä¾¿åˆ©åº— / æ˜æ´æ•£æ­¥ çš†å¯",
              bizTime:"",fee:"",note:"",
              map:"",move:0
            }
          ]
        },
        {
          id:"d4",
          labelShort:"12/28",
          weekday:"æ—¥",
          title:"Day 4ï½œè–æ°´ ALL DAY â†’ æ˜æ´ï¼ˆæ™šé¤äºŒé¸ä¸€ï¼‰",
          city:"Seoul",
          weather:{temp:"",low:"",feel:"",text:"",note:"è–æ°´ cafÃ©ï¼‹æ½®åº—ï¼Œæ™šé¤äºŒé¸ä¸€"},
          blocks:[
            {
              id:"d4b1",type:"food",icon:"ğŸ",time:"æ—©ä¸Š",
              title:"Onion è–æ°´",
              location:"ì–´ë‹ˆì–¸ ì„±ìˆ˜ Â· ì„œìš¸ ì„±ë™êµ¬ ì•„ì°¨ì‚°ë¡œ17ê¸¸ 33",
              bizTime:"",fee:"",note:"",
              map:"",move:0
            },
            {
              id:"d4b2",type:"shopping",icon:"ğŸ›",time:"ä¸Šåˆ",
              title:"è–æ°´æ½®æµæ•£æ­¥",
              location:"Musinsa / ADER ERROR / Tamburins è–æ°´ ä¸€å¸¶",
              bizTime:"",fee:"",
              note:"Musinsaï¼ˆë¬´ì‹ ì‚¬ ìŠ¤íƒ ë‹¤ë“œ ì„±ìˆ˜ï¼‰Â· ì—°ë¬´ì¥ê¸¸ 9\nADER ERRORï¼ˆì•„ë”ì—ëŸ¬ ì„±ìˆ˜ï¼‰Â· ì—°ë¬´ì¥ê¸¸ 18\nTamburins è–æ°´ï¼ˆíƒ¬ë²„ë¦°ì¦ˆ ì„±ìˆ˜ï¼‰Â· ì—°ë¬´ì¥ê¸¸ 13",
              map:"",move:12
            },
            {
              id:"d4b3",type:"food",icon:"ğŸ½",time:"ä¸­åˆ",
              title:"ç„¡å¢å±‹ï¼ˆçƒå†¬ï¼‰",
              location:"ë¬´ì¿ ìš°ë™ Â· ì„œìš¸ ì„±ë™êµ¬ ì„œìš¸ìˆ²2ê¸¸ 28-13",
              bizTime:"",fee:"",note:"",
              map:"",move:8
            },
            {
              id:"d4b4",type:"food",icon:"ğŸ®",time:"ä¸‹åˆ",
              title:"Milky Shop ç”œå“",
              location:"ë°€í‚¤ìƒµ Â· ì„œìš¸ ì„±ë™êµ¬ ì„œìš¸ìˆ²2ê¸¸ 19-13",
              bizTime:"",fee:"",note:"",
              map:"",move:8
            },
            {
              id:"d4b5",type:"transport",icon:"ğŸš‡",time:"å‚æ™šå‰",
              title:"è–æ°´ â†’ æ˜æ´ï¼ˆåœ°éµï¼‰",
              location:"ç´„ 20â€“25 åˆ†é˜",
              bizTime:"ç§»å‹•ç´„ 20â€“25 åˆ†é˜",
              fee:"",note:"",
              map:"",move:25
            },
            {
              id:"d4b6",type:"food",icon:"ğŸ²",time:"æ™šä¸Š",
              title:"â‘  IDAEJO æ’éª¨æ¹¯",
              location:"ì´ëŒ€ì¡° ê°ìíƒ• Â· ì„œìš¸ ì„œëŒ€ë¬¸êµ¬ ì´í™”ì—¬ëŒ€3ê¸¸ 22",
              bizTime:"",fee:"",note:"",
              map:"",move:0
            },
            {
              id:"d4b7",type:"food",icon:"ğŸ—",time:"æ™šä¸Š",
              title:"â‘¡ æ˜æ´ç‚¸é›ï¼ˆæ€å…¶ä¸€ï¼‰",
              location:"æ©‹æ‘ / bb.q / NENEï¼ˆæ˜æ´ä¸€å¸¶ï¼‰",
              bizTime:"",fee:"",
              note:"æ©‹æ‘ï¼ˆêµì´Œì¹˜í‚¨ ëª…ë™ì ï¼‰Â· ì„œìš¸ ä¸­êµ¬ ëª…ë™8ê°€ê¸¸ 19\nbb.qï¼ˆë¹„ë¹„í ëª…ë™ì ï¼‰Â· ì„œìš¸ ä¸­êµ¬ ëª…ë™8ê°€ê¸¸ 37\nNENEï¼ˆë„¤ë„¤ì¹˜í‚¨ ëª…ë™ì ï¼‰Â· ì„œìš¸ ä¸­êµ¬ ëª…ë™7ê¸¸ 21",
              map:"",move:0
            }
          ]
        },
        {
          id:"d5",
          labelShort:"12/29",
          weekday:"ä¸€",
          title:"Day 5ï½œæœ€å¾Œè£œè²¨ â†’ é°»é­š â†’ æ©Ÿå ´",
          city:"Seoul",
          weather:{temp:"",low:"",feel:"",text:"",note:"å›ç¨‹æ—¥ï¼Œæœ€å¾Œè³¼ç‰©ï¼‹é°»é­šåˆé¤"},
          blocks:[
            {
              id:"d5b1",type:"food",icon:"ğŸ¥ª",time:"æ—©ä¸Š",
              title:"Egg Dropï¼ˆæ˜æ´ï¼‰",
              location:"ì—ê·¸ë“œë Â· ì„œìš¸ ä¸­êµ¬ ëª…ë™ê¸¸ 24",
              bizTime:"",fee:"",note:"",
              map:"",move:0
            },
            {
              id:"d5b2",type:"shopping",icon:"ğŸ›",time:"ä¸Šåˆ",
              title:"æ˜æ´æœ€å¾Œæƒè²¨",
              location:"ëª…ë™ê±°ë¦¬ Â· ì„œìš¸ ä¸­êµ¬ ëª…ë™ê¸¸ ä¸€å¸¶",
              bizTime:"",fee:"",note:"",
              map:"",move:5
            },
            {
              id:"d5b3",type:"food",icon:"ğŸ½",time:"ä¸­åˆ",
              title:"è±å·é°»é­šï¼ˆåˆé¤ï¼‰",
              location:"í’ì²œì¥ì–´ Â· ì„œìš¸ ä¸­êµ¬ ëª…ë™4ê¸¸ 10",
              bizTime:"",fee:"",note:"",
              map:"",move:10
            },
            {
              id:"d5b4",type:"flight",icon:"âœˆï¸",time:"ä¸‹åˆ",
              title:"å›é…’åº—æ‹è¡Œæ â†’ æ©Ÿå ´",
              location:"UO631 ICN â†’ HKG",
              bizTime:"é ç•™å……è¶³æ™‚é–“è¿”æ©Ÿå ´",
              fee:"",note:"",
              map:"",move:40
            }
          ]
        }
      ],
      expenses:[],
      flights:[
        {date:"12/25",no:"UO626",route:"HKG â†’ ICN",time:""},
        {date:"12/29",no:"UO631",route:"ICN â†’ HKG",time:""}
      ],
      hotels:[],
      rental:{company:"",place:"",period:"",car:"",note:""},
      fx:{rate:0.006,krw:"",hkd:""}
    };

    let trip;
    try{
      const stored = JSON.parse(localStorage.getItem(STORAGE_KEY) || "null");
      trip = stored || baseTrip;
    }catch(e){ trip = baseTrip; }

    function saveAll(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(trip)); }

    const dayStrip = document.getElementById('dayStrip');
    const itineraryPanel = document.getElementById('panel-itinerary');
    const expensePanel = document.getElementById('panel-expense');
    const flightPanel = document.getElementById('panel-flight');
    const infoPanel = document.getElementById('panel-info');

    const tabIt = document.getElementById('tab-itinerary');
    const tabEx = document.getElementById('tab-expense');
    const tabFl = document.getElementById('tab-flight');
    const tabInfo = document.getElementById('tab-info');
    const editToggleBtn = document.getElementById('editToggle');
    const printBtn = document.getElementById('btnPrint');
    const weatherAllBtn = document.getElementById('btnWeatherAll');

    const modalBackdrop = document.getElementById('modalBackdrop');
    const btnModalClose = document.getElementById('btnModalClose');
    const btnModalCancel = document.getElementById('btnModalCancel');
    const btnModalSave = document.getElementById('btnModalSave');
    const btnModalDelete = document.getElementById('btnModalDelete');

    const fType = document.getElementById('fType');
    const fIcon = document.getElementById('fIcon');
    const fTime = document.getElementById('fTime');
    const fTitle = document.getElementById('fTitle');
    const fLocation = document.getElementById('fLocation');
    const fBizTime = document.getElementById('fBizTime');
    const fFee = document.getElementById('fFee');
    const fNote = document.getElementById('fNote');
    const fMap = document.getElementById('fMap');
    const fMove = document.getElementById('fMove');

    let currentDayIndex = 0;
    let editMode = false;
    let editingDayIndex = null;
    let editingBlockIndex = null;

    function getTypeColor(t){ return typeColors[t] || typeColors.other; }

    /* ====== Day pills ====== */
    function renderDayPills(){
      const wrap = document.createElement('div');
      wrap.className = 'day-scroll';
      trip.days.forEach((d,i)=>{
        const pill = document.createElement('div');
        pill.className = 'day-pill'+(i===currentDayIndex?' active':'');
        pill.dataset.index = i;
        pill.innerHTML = `<span class="date">${d.labelShort}</span><span>${d.weekday}</span>`;
        pill.addEventListener('click',()=>{
          currentDayIndex = i;
          document.querySelectorAll('.day-pill').forEach(p=>p.classList.remove('active'));
          pill.classList.add('active');
          renderItinerary();
        });
        wrap.appendChild(pill);
      });
      dayStrip.innerHTML = '';
      dayStrip.appendChild(wrap);
    }

    /* ====== Modal æ§åˆ¶ ====== */
    function openModal(dayIndex, blockIndex){
      editingDayIndex = dayIndex;
      editingBlockIndex = blockIndex;
      const day = trip.days[dayIndex];
      let block;
      if(blockIndex === -1){
        block = {
          id: "tmp-"+Date.now(),
          type:"other",
          icon:"ğŸ“",
          time:"",
          title:"æ–°è¡Œç¨‹",
          location:"",
          bizTime:"",
          fee:"",
          note:"",
          map:"",
          move:0
        };
      }else{
        block = Object.assign({}, day.blocks[blockIndex]);
      }

      fType.value = block.type;
      fIcon.value = block.icon || "";
      fTime.value = block.time || "";
      fTitle.value = block.title || "";
      fLocation.value = block.location || "";
      fBizTime.value = block.bizTime || "";
      fFee.value = block.fee || "";
      fNote.value = block.note || "";
      fMap.value = block.map || "";
      fMove.value = block.move ? String(block.move) : "";

      btnModalDelete.style.display = (blockIndex === -1) ? "none" : "inline-block";
      modalBackdrop.style.display = 'flex';
    }
    function closeModal(){
      modalBackdrop.style.display = 'none';
      editingDayIndex = null;
      editingBlockIndex = null;
    }
    btnModalClose.onclick = btnModalCancel.onclick = closeModal;

    btnModalSave.onclick = function(){
      if(editingDayIndex == null) return;
      const d = trip.days[editingDayIndex];
      const block = {
        id: (editingBlockIndex === -1 ? "b"+Date.now() : d.blocks[editingBlockIndex].id),
        type:fType.value || "other",
        icon:fIcon.value || "ğŸ“",
        time:fTime.value || "",
        title:fTitle.value || "",
        location:fLocation.value || "",
        bizTime:fBizTime.value || "",
        fee:fFee.value || "",
        note:fNote.value || "",
        map:fMap.value || "",
        move:parseInt(fMove.value || "0",10) || 0
      };
      if(editingBlockIndex === -1){
        d.blocks.push(block);
      }else{
        d.blocks[editingBlockIndex] = block;
      }
      saveAll();
      renderItinerary();
      closeModal();
    };

    btnModalDelete.onclick = function(){
      if(editingDayIndex == null || editingBlockIndex == null || editingBlockIndex === -1) return;
      const d = trip.days[editingDayIndex];
      d.blocks.splice(editingBlockIndex,1);
      saveAll();
      renderItinerary();
      closeModal();
    };

    /* ====== å¤©æ°£ ====== */
    async function fetchWeatherForDay(index){
  const d = trip.days[index];
  const cityQuery = (d.city || "Seoul") + ",KR";
  try{
    const url = `https://api.openweathermap.org/data/2.5/weather?q=${encodeURIComponent(cityQuery)}&units=metric&lang=zh_tw&appid=${API_KEY}`;
    const res = await fetch(url);
    if(!res.ok) throw new Error("HTTP "+res.status);
    const data = await res.json();

    const w0 = data.weather && data.weather[0] ? data.weather[0] : null;

    d.weather.temp = Math.round(data.main.temp).toString();
    d.weather.low  = Math.round(data.main.temp_min).toString();
    d.weather.feel = Math.round(data.main.feels_like).toString();
    d.weather.text = w0 ? (w0.description || "") : "";

    // â­ æ–°å¢ï¼šå„²å­˜ id / main / iconï¼Œä¿¾ emoji ç”¨
    d.weather.id    = w0 ? w0.id   : null;
    d.weather.main  = w0 ? w0.main : "";
    d.weather.icon  = w0 ? w0.icon : "";

    saveAll();
  }catch(e){
    console.error(e);
    alert("å–å¾—å¤©æ°£å¤±æ•—ï¼Œå¯ä»¥ä¹‹å¾Œå†è©¦ä¸€æ¬¡ã€‚");
  }
}

    async function updateAllWeather(){
      for(let i=0;i<trip.days.length;i++){
        await fetchWeatherForDay(i);
      }
      renderItinerary();
      alert("å·²æ›´æ–°é¦–çˆ¾å³æ™‚å¤©æ°£ï¼ˆæ‰€æœ‰æ—¥å­é¡¯ç¤ºåŒä¸€åˆ»å¤©æ°£ï¼‰âœ…");
    }

    function labelType(t){
      switch(t){
        case "transport":return "äº¤é€š";
        case "flight":return "èˆªç­";
        case "food":return "é£²é£Ÿ";
        case "sight":return "æ™¯é»";
        case "hotel":return "ä½å®¿";
        case "shopping":return "è³¼ç‰©";
        default:return "å…¶ä»–";
      }
    }
// æ ¹æ“š OpenWeather å¤©æ°£è³‡æ–™ï¼Œæ±ºå®šç”¨å’© emoji
function getWeatherEmoji(w){
  const id = w && w.id ? w.id : 0;
  const main = (w && w.main ? w.main : "").toLowerCase();
  const text = (w && w.text ? w.text : "").toLowerCase();

  // æœ‰ id å°±ç”¨ id åˆ¤æ–·
  if(id >= 200 && id < 300) return "â›ˆï¸";        // Thunderstorm
  if(id >= 300 && id < 600) return "ğŸŒ§ï¸";        // Drizzle / Rain
  if(id >= 600 && id < 700) return "â„ï¸";        // Snow
  if(id >= 700 && id < 800) return "ğŸŒ«ï¸";        // Mist / Fog / Hazeâ€¦
  if(id === 800)             return "â˜€ï¸";        // Clear sky
  if(id > 800 && id < 900)   return "â˜ï¸";        // Clouds

  // å†‡ id æˆ–è€…å¥½å¥‡æ€ªå˜…æƒ…æ³ï¼Œå°±ç”¨æ–‡å­—å†ä¼°å¤šæ¬¡
  if(main.includes("thunder")) return "â›ˆï¸";
  if(main.includes("rain") || text.includes("é›¨")) return "ğŸŒ§ï¸";
  if(main.includes("snow") || text.includes("é›ª")) return "â„ï¸";
  if(main.includes("cloud")) return "â˜ï¸";
  if(main.includes("clear")) return "â˜€ï¸";

  // default
  return "ğŸŒ¤";
}
    /* ====== è¡Œç¨‹æ¸²æŸ“ ====== */
    function renderItinerary(){
      const d = trip.days[currentDayIndex];
      const w = d.weather;
      itineraryPanel.innerHTML = '';

      const weather = document.createElement('div');
      weather.className = 'weather-card';
      weather.innerHTML = `
       <div class="weather-icon">${emoji}</div>
        <div class="weather-main">
          <div style="font-size:11px;color:#777;margin-bottom:2px;">å³æ™‚é¦–çˆ¾å¤©æ°£ï¼ˆéè¡Œç¨‹æ—¥æœŸé å ±ï¼‰</div>
          <div class="temp-row">${w.temp ? w.temp+"Â°C" : "--"} 
            <span class="temp-low">${w.low ? "/ "+w.low+"Â°C" : ""}</span>
          </div>
          <div class="feel">
            ${w.feel ? "é«”æ„Ÿ "+w.feel+"Â°C ãƒ» " : ""}${w.text || "é¦–æ¬¡ä½¿ç”¨å¯æŒ‰ä¸‹é¢æŒ‰éˆ•æ›´æ–°é¦–çˆ¾å³æ™‚å¤©æ°£ã€‚"}
          </div>
          <button class="weather-btn" id="btnWeatherOne">â†» æ›´æ–°å³æ™‚å¤©æ°£ï¼ˆæ­¤æ—¥é¡¯ç¤ºï¼‰</button>
        </div>
        <div class="weather-note">
          <strong>ä»Šæ—¥é‡é»</strong>
          <span>${w.note || ""}</span>
        </div>
      `;
      itineraryPanel.appendChild(weather);

      const secTitle = document.createElement('div');
      secTitle.className = 'section-title';
      secTitle.textContent = d.title;
      itineraryPanel.appendChild(secTitle);

      d.blocks.forEach((b,idx)=>{
        if(b.move && idx>0){
          const mt = document.createElement('div');
          mt.className = 'move-time';
          mt.textContent = `â‰ˆ ${b.move} min`;
          itineraryPanel.appendChild(mt);
        }
        const card = document.createElement('div');
        card.className = 'card';
        const color = getTypeColor(b.type);
        card.innerHTML = `
          <div class="card-icon-wrap">
            <div class="card-icon-circle" style="background:${color};">${b.icon || "ğŸ“"}</div>
            <div class="card-icon-label">${b.time || ""}</div>
          </div>
          <div class="card-body">
            <div class="card-title-row">
              <div class="card-title">${b.title || ""}</div>
            </div>
            <div class="card-sub">${b.location || ""}</div>
            <div class="card-meta">
              ${b.bizTime ? `<span class="meta-pill">â± ${b.bizTime}</span>` : ""}
              ${b.fee ? `<span class="meta-pill">ğŸ’´ ${b.fee}</span>` : ""}
              ${b.map ? `<span class="meta-pill">ğŸ“ å·²è¨­å®šåœ°åœ–</span>` : ""}
              <span class="meta-pill">${labelType(b.type)}</span>
            </div>
            ${b.note ? `<div class="card-note">${b.note}</div>` : ""}
            <div class="card-footer">
              <button class="icon-btn" data-act="up" data-idx="${idx}">â–²</button>
              <button class="icon-btn" data-act="down" data-idx="${idx}">â–¼</button>
              <button class="icon-btn primary" data-act="nav" data-idx="${idx}">ğŸ“</button>
              <button class="icon-btn" data-act="edit" data-idx="${idx}">âœï¸</button>
              <button class="icon-btn" data-act="del" data-idx="${idx}">ğŸ—‘</button>
            </div>
          </div>
        `;
        itineraryPanel.appendChild(card);
      });

      if(editMode){
        const addBtn = document.createElement('button');
        addBtn.className = 'btn-pill btn-secondary';
        addBtn.style.width = "100%";
        addBtn.style.marginTop = "8px";
        addBtn.textContent = "ï¼‹ æ–°å¢ä¸€é …è¡Œç¨‹";
        addBtn.onclick = ()=>openModal(currentDayIndex,-1);
        itineraryPanel.appendChild(addBtn);
      }

      const hint = document.createElement('div');
      hint.className = 'small-note';
      hint.textContent = 'æç¤ºï¼šå¤©æ°£ç‚ºé¦–çˆ¾ã€Œå³æ™‚ç‹€æ…‹ã€ï¼Œæ‰€æœ‰æ—¥å­æœƒé¡¯ç¤ºåŒä¸€åˆ»çš„çµæœï¼›è©³ç´°é å ±å¯è‡ªè¡Œé–‹å¤©æ°£ App æŸ¥çœ‹ã€‚';
      itineraryPanel.appendChild(hint);

      const oneBtn = document.getElementById('btnWeatherOne');
      if(oneBtn){
        oneBtn.onclick = async ()=>{
          await fetchWeatherForDay(currentDayIndex);
          renderItinerary();
          alert("å·²æ›´æ–°é¦–çˆ¾å³æ™‚å¤©æ°£ âœ…");
        };
      }
    }

    /* ====== å¡ç‰‡ footer handlerï¼ˆåªç¶ä¸€æ¬¡ï¼‰ ====== */
    function cardFooterHandler(e){
      const btn = e.target.closest('.icon-btn');
      if(!btn) return;
      const act = btn.dataset.act;
      const idx = parseInt(btn.dataset.idx,10);
      if(isNaN(idx)) return;
      const day = trip.days[currentDayIndex];

      if(act === "up" && idx > 0){
        const tmp = day.blocks[idx-1];
        day.blocks[idx-1] = day.blocks[idx];
        day.blocks[idx] = tmp;
        saveAll();
        renderItinerary();

      }else if(act === "down" && idx < day.blocks.length-1){
        const tmp = day.blocks[idx+1];
        day.blocks[idx+1] = day.blocks[idx];
        day.blocks[idx] = tmp;
        saveAll();
        renderItinerary();

      }else if(act === "nav"){
        const b = day.blocks[idx];
        if(b.map){
          window.open(b.map, "_blank");
        }else{
          alert("å‘¢é …æœªè¨­å®šåœ°åœ–é€£çµï¼Œå¯ä»¥æŒ‰ âœï¸ é€²å»ç·¨è¼¯åŠ å…¥ Naver / Google linkã€‚");
        }

      }else if(act === "edit"){
        openModal(currentDayIndex, idx);

      }else if(act === "del"){
        if(confirm("ç¢ºå®šåˆªé™¤é€™ä¸€é …è¡Œç¨‹å—ï¼Ÿ")){
          day.blocks.splice(idx,1);
          saveAll();
          renderItinerary();
        }
      }
    }

    /* ====== æ¶ˆè²»é  ====== */
    function renderExpenses(){
      expensePanel.innerHTML = '';
      const title = document.createElement('div');
      title.className = 'section-title';
      title.textContent = 'æ”¯å‡ºç´€éŒ„';
      expensePanel.appendChild(title);

      const table = document.createElement('table');
      table.className = 'table';
      table.innerHTML = `
        <thead>
          <tr>
            <th style="width:18%;">æ—¥æœŸ</th>
            <th style="width:22%;">é¡åˆ¥</th>
            <th style="width:30%;">é …ç›®</th>
            <th style="width:20%;">é‡‘é¡ (KRW)</th>
            <th style="width:10%;">âœ•</th>
          </tr>
        </thead>
        <tbody></tbody>
      `;
      const tbody = table.querySelector('tbody');

      trip.expenses.forEach((e,idx)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><input value="${e.date||""}" placeholder="12/25"></td>
          <td><input value="${e.cat||""}" placeholder="ä½å®¿/é£²é£Ÿ"></td>
          <td><input value="${e.item||""}" placeholder="åº—å/å‚™è¨»"></td>
          <td><input value="${e.amount||""}" placeholder="10000"></td>
          <td style="text-align:center;"><button class="del-btn" data-i="${idx}">åˆª</button></td>
        `;
        tbody.appendChild(tr);
      });

      expensePanel.appendChild(table);

      const actions = document.createElement('div');
      actions.className = 'table-actions';
      actions.innerHTML = `
        <button class="btn-pill btn-secondary" id="btnAddExpense">ï¼‹ æ–°å¢ä¸€ç­†</button>
        <button class="btn-pill btn-primary" id="btnSaveExpense">å„²å­˜æ¶ˆè²»</button>
      `;
      expensePanel.appendChild(actions);

      actions.querySelector('#btnAddExpense').onclick = ()=>{
        trip.expenses.push({date:"",cat:"",item:"",amount:""});
        saveAll(); renderExpenses();
      };

      tbody.onclick = e=>{
        if(e.target.classList.contains('del-btn')){
          const i = Number(e.target.dataset.i);
          trip.expenses.splice(i,1);
          saveAll(); renderExpenses();
        }
      };

      actions.querySelector('#btnSaveExpense').onclick = ()=>{
        const rows = tbody.querySelectorAll('tr');
        const list = [];
        rows.forEach(r=>{
          const [d,cat,item,amt] = r.querySelectorAll('input');
          if(d.value || cat.value || item.value || amt.value){
            list.push({date:d.value,cat:cat.value,item:item.value,amount:amt.value});
          }
        });
        trip.expenses = list;
        saveAll();
        renderExpenses();
        alert("æ¶ˆè²»ç´€éŒ„å·²å„²å­˜ âœ…");
      };

      const sumByDay = {};
      let total = 0;
      trip.expenses.forEach(e=>{
        const n = parseFloat(String(e.amount||"").replace(/,/g,""));
        if(isNaN(n)) return;
        total += n;
        if(e.date) sumByDay[e.date] = (sumByDay[e.date]||0)+n;
      });
      const totalDiv = document.createElement('div');
      totalDiv.className = 'total-row';
      const parts = Object.entries(sumByDay).map(([d,v])=>`${d}: ${v.toLocaleString()} KRW`);
      totalDiv.textContent = parts.length
        ? `å„æ—¥å°è¨ˆï¼š${parts.join(" ï½œ ")}ã€€ï½œã€€ç›®å‰ç¸½èŠ±è²»ï¼š${total.toLocaleString()} KRW`
        : "å°šæœªè¼¸å…¥ä»»ä½•æ¶ˆè²»ã€‚";
      expensePanel.appendChild(totalDiv);
    }

    /* ====== èˆªç­é  ====== */
    function renderFlights(){
      flightPanel.innerHTML = '';
      const title = document.createElement('div');
      title.className = 'section-title';
      title.textContent = 'èˆªç­è³‡æ–™';
      flightPanel.appendChild(title);

      const table = document.createElement('table');
      table.className = 'table';
      table.innerHTML = `
        <thead>
          <tr>
            <th style="width:18%;">æ—¥æœŸ</th>
            <th style="width:22%;">èˆªç­</th>
            <th style="width:40%;">èˆªç·š</th>
            <th style="width:12%;">æ™‚é–“</th>
            <th style="width:8%;">âœ•</th>
          </tr>
        </thead>
        <tbody></tbody>
      `;
      const tbody = table.querySelector('tbody');

      trip.flights.forEach((f,idx)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><input value="${f.date||""}"></td>
          <td><input value="${f.no||""}"></td>
          <td><input value="${f.route||""}"></td>
          <td><input value="${f.time||""}"></td>
          <td style="text-align:center;"><button class="del-btn" data-i="${idx}">åˆª</button></td>
        `;
        tbody.appendChild(tr);
      });

      flightPanel.appendChild(table);

      const actions = document.createElement('div');
      actions.className = 'table-actions';
      actions.innerHTML = `
        <button class="btn-pill btn-secondary" id="btnAddFlight">ï¼‹ æ–°å¢èˆªç­</button>
        <button class="btn-pill btn-primary" id="btnSaveFlight">å„²å­˜èˆªç­</button>
      `;
      flightPanel.appendChild(actions);

      actions.querySelector('#btnAddFlight').onclick = ()=>{
        trip.flights.push({date:"",no:"",route:"",time:""});
        saveAll(); renderFlights();
      };

      tbody.onclick = e=>{
        if(e.target.classList.contains('del-btn')){
          const i = Number(e.target.dataset.i);
          trip.flights.splice(i,1);
          saveAll(); renderFlights();
        }
      };

      actions.querySelector('#btnSaveFlight').onclick = ()=>{
        const rows = tbody.querySelectorAll('tr');
        const list = [];
        rows.forEach(r=>{
          const [d,no,route,time] = r.querySelectorAll('input');
          if(d.value || no.value || route.value || time.value){
            list.push({date:d.value,no:no.value,route:route.value,time:time.value});
          }
        });
        trip.flights = list;
        saveAll();
        alert("èˆªç­è³‡æ–™å·²å„²å­˜ âœ…");
      };
    }

    /* ====== è³‡è¨Šé ï¼ˆåŒ¯ç‡ï¼é…’åº—ï¼ç§Ÿè»Šï¼‰ ====== */
    function renderInfo(){
      infoPanel.innerHTML = "";

      const fxCard = document.createElement('div');
      fxCard.className = 'info-card';
      fxCard.innerHTML = `
        <div class="info-title">
          <span>åŒ¯ç‡æ›ç®—ï¼ˆKRW â†” HKDï¼‰</span>
          <span style="font-size:11px;color:#777;">åŒ¯ç‡åŸºæº– = KRW Ã— åŒ¯ç‡ â†’ HKD</span>
        </div>
        <div class="info-row">
          <label>åŒ¯ç‡</label>
          <input id="fxRate" value="${trip.fx.rate}">
        </div>
        <div class="info-row">
          <label>KRW</label>
          <input id="fxKrw" value="${trip.fx.krw||""}">
        </div>
        <div class="info-row">
          <label>HKD</label>
          <input id="fxHkd" value="${trip.fx.hkd||""}">
        </div>
      `;
      infoPanel.appendChild(fxCard);

      const fxRate = ()=>parseFloat(document.getElementById('fxRate').value||"0");
      const krwInput = fxCard.querySelector('#fxKrw');
      const hkdInput = fxCard.querySelector('#fxHkd');
      fxCard.querySelector('#fxRate').addEventListener('input',()=>{
        trip.fx.rate = fxRate() || 0;
        saveAll();
      });
      krwInput.addEventListener('input',()=>{
        const r = fxRate(); const n = parseFloat(krwInput.value||"0");
        if(!isNaN(n) && r){
          hkdInput.value = (n*r).toFixed(2);
        }
        trip.fx.krw = krwInput.value;
        trip.fx.hkd = hkdInput.value;
        saveAll();
      });
      hkdInput.addEventListener('input',()=>{
        const r = fxRate(); const n = parseFloat(hkdInput.value||"0");
        if(!isNaN(n) && r){
          krwInput.value = Math.round(n/r);
        }
        trip.fx.krw = krwInput.value;
        trip.fx.hkd = hkdInput.value;
        saveAll();
      });

      const hotelTitle = document.createElement('div');
      hotelTitle.className = 'section-title';
      hotelTitle.textContent = 'ä½å®¿è³‡è¨Š';
      infoPanel.appendChild(hotelTitle);

      const hotelTable = document.createElement('table');
      hotelTable.className = 'table';
      hotelTable.innerHTML = `
        <thead>
          <tr>
            <th style="width:26%;">é…’åº—åç¨±</th>
            <th style="width:18%;">æ—¥æœŸ</th>
            <th style="width:32%;">åœ°å€ / é›»è©±</th>
            <th style="width:16%;">åœ°åœ–é€£çµ</th>
            <th style="width:8%;">âœ•</th>
          </tr>
        </thead>
        <tbody></tbody>
      `;
      const hBody = hotelTable.querySelector('tbody');

      trip.hotels.forEach((h,idx)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><input value="${h.name||""}"></td>
          <td><input value="${h.date||""}" placeholder="12/25-26"></td>
          <td><input value="${h.detail||""}" placeholder="åœ°å€ / é›»è©±"></td>
          <td><input value="${h.map||""}" placeholder="https://"></td>
          <td style="text-align:center;"><button class="del-btn" data-i="${idx}">åˆª</button></td>
        `;
        hBody.appendChild(tr);
      });

      infoPanel.appendChild(hotelTable);

      const hActions = document.createElement('div');
      hActions.className = 'table-actions';
      hActions.innerHTML = `
        <button class="btn-pill btn-secondary" id="btnAddHotel">ï¼‹ æ–°å¢ä½å®¿</button>
        <button class="btn-pill btn-primary" id="btnSaveHotel">å„²å­˜ä½å®¿è³‡è¨Š</button>
      `;
      infoPanel.appendChild(hActions);

      hActions.querySelector('#btnAddHotel').onclick = ()=>{
        trip.hotels.push({name:"",date:"",detail:"",map:""});
        saveAll(); renderInfo();
      };
      hBody.onclick = e=>{
        if(e.target.classList.contains('del-btn')){
          const i = Number(e.target.dataset.i);
          trip.hotels.splice(i,1);
          saveAll(); renderInfo();
        }
      };
      hActions.querySelector('#btnSaveHotel').onclick = ()=>{
        const rows = hBody.querySelectorAll('tr');
        const list=[];
        rows.forEach(r=>{
          const [name,date,detail,map] = r.querySelectorAll('input');
          if(name.value || date.value || detail.value || map.value){
            list.push({name:name.value,date:date.value,detail:detail.value,map:map.value});
          }
        });
        trip.hotels = list;
        saveAll();
        alert("ä½å®¿è³‡è¨Šå·²å„²å­˜ âœ…");
      };

      const rentTitle = document.createElement('div');
      rentTitle.className = 'section-title';
      rentTitle.textContent = 'ç§Ÿè»Šè³‡è¨Šï¼ˆå¦‚æœ‰ï¼‰';
      infoPanel.appendChild(rentTitle);

      const rCard = document.createElement('div');
      rCard.className = 'info-card';
      rCard.innerHTML = `
        <div class="info-row">
          <label>å…¬å¸</label>
          <input id="rCompany" value="${trip.rental.company||""}">
        </div>
        <div class="info-row">
          <label>å–è»Š / é‚„è»Šé»</label>
          <input id="rPlace" value="${trip.rental.place||""}">
        </div>
        <div class="info-row">
          <label>æœŸé–“</label>
          <input id="rPeriod" value="${trip.rental.period||""}" placeholder="ä¾‹ï¼š12/27 09:00 â€“ 12/29 20:00">
        </div>
        <div class="info-row">
          <label>è»Šå‹</label>
          <input id="rCar" value="${trip.rental.car||""}">
        </div>
        <div class="info-row">
          <label>å‚™è¨»</label>
          <input id="rNote" value="${trip.rental.note||""}">
        </div>
      `;
      infoPanel.appendChild(rCard);

      ["Company","Place","Period","Car","Note"].forEach(key=>{
        const el = rCard.querySelector("#r"+key);
        el.addEventListener('input',()=>{
          const k = key.toLowerCase();
          trip.rental[k] = el.value;
          saveAll();
        });
      });

      const note = document.createElement('div');
      note.className = 'small-note';
      note.textContent = 'æç¤ºï¼šä»¥ä¸Šè³‡è¨Šå…¨éƒ¨åªå„²å­˜åœ¨ä½ ç€è¦½å™¨æœ¬æ©Ÿï¼Œä¸æœƒä¸Šè¼‰åˆ°ä¼ºæœå™¨ã€‚';
      infoPanel.appendChild(note);
    }

    /* ====== Tab èˆ‡å…¶ä»–æ§åˆ¶ ====== */
    function switchTab(tab){
      [tabIt,tabEx,tabFl,tabInfo].forEach(b=>b.classList.remove('active'));
      tab.classList.add('active');
      const id = tab.id;
      itineraryPanel.style.display = (id==="tab-itinerary")?"block":"none";
      expensePanel.style.display = (id==="tab-expense")?"block":"none";
      flightPanel.style.display = (id==="tab-flight")?"block":"none";
      infoPanel.style.display = (id==="tab-info")?"block":"none";
    }

    tabIt.onclick = ()=>switchTab(tabIt);
    tabEx.onclick = ()=>switchTab(tabEx);
    tabFl.onclick = ()=>switchTab(tabFl);
    tabInfo.onclick = ()=>switchTab(tabInfo);

    editToggleBtn.onclick = ()=>{
      editMode = !editMode;
      if(editMode){
        editToggleBtn.classList.add('active');
        editToggleBtn.textContent = "âœ… å¯æ–°å¢è¡Œç¨‹";
      }else{
        editToggleBtn.classList.remove('active');
        editToggleBtn.textContent = "âœï¸ ç·¨è¼¯è¡Œç¨‹";
      }
      renderItinerary();
    };

    printBtn.onclick = ()=>window.print();
    weatherAllBtn.onclick = updateAllWeather;

    function init(){
      renderDayPills();
      renderItinerary();
      renderExpenses();
      renderFlights();
      renderInfo();
      switchTab(tabIt);

      // â­ ç¶ä¸€æ¬¡å°±å¤ ï¼Œå””æœƒå†å‡ºã€Œè¦ refresh å…ˆæœ‰åæ‡‰ã€å•é¡Œ
      itineraryPanel.addEventListener('click', cardFooterHandler);
    }
    init();
  </script>
</body>
</html>